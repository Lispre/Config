#!/bin/sh -e
cd ~/projects/linux-2.6
[ -n "$1" ] && git pull
make menuconfig
sudo make CC=/usr/lib/ccache/bin/cc -j4
sudo mount /boot
sudo make install modules_install

VERS=`cat ~ray/projects/linux-2.6/include/config/kernel.release`
OLDVERS=`grep -m1 -Po '(?<=vmlinuz-)[^ ]*' /boot/grub/grub.conf`
echo current version: $VERS
echo latest version in grub.conf: $OLDVERS
if [ "$VERS" != "$OLDVERS" ]; then
    sudo vim /boot/grub/grub.conf -c '/title' -c '.,.+3co 10' -c '1' -c "11,13s/Linux (\\([^)]*\\))/Linux ($VERS)/" -c "13s/vmlinuz-[^ ]*/vmlinuz-$VERS/"
fi
